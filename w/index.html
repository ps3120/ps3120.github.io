<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>TypedArray Crash Test</title>
</head>
<body>
  <h1>TypedArray Immediate Crash</h1>

  <script>
    let externalMemory = new Uint8Array([1, 2, 3, 4]);

    function fakeDeallocator(buffer, context) {
      alert("[deallocator] Deallocator chiamato!");

      // Sovrascrivi brutalmente la memoria!
      for (let i = 0; i < buffer.length; i++) {
        buffer[i] = null; // <<<<< Qui rompiamo completamente
      }

      // Libera il riferimento principale
      externalMemory = null;
    }

    function createTypedArrayWithExternalBuffer(bytes, length, destructor, context) {
      const buffer = bytes.buffer;
      const view = new Uint8Array(buffer, 0, length);
      return {
        view,
        destroy() {
          if (destructor) destructor(view, context);
        }
      };
    }

    alert("Creazione TypedArray da memoria esterna...");
    const handle = createTypedArrayWithExternalBuffer(externalMemory, 4, fakeDeallocator, "ps4Context");

    alert("Contenuto iniziale: " + handle.view.join(", "));

    alert("Distruzione della memoria condivisa...");
    handle.destroy();

    // Heap spray - cerca di occupare la memoria liberata
    let spray = [];
    for (let i = 0; i < 10000; i++) {
      spray.push(new ArrayBuffer(0x100));
    }

    alert("Accesso dopo destroy...");
    // FORZA il crash tentando di leggere o scrivere su dati invalidi
    handle.view[0] = 42; // <<< SCRITTURA

    alert("Se vedi questo alert, il crash non Ã¨ avvenuto!");
  </script>
</body>
</html>
