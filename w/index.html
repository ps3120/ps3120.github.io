<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>PS4 Crash TypedArray UAF Test</title>
</head>
<body>
  <h1>TypedArray UAF Simulation for PS4</h1>

  <script>
    let externalMemory = new Uint8Array([1, 2, 3, 4]);

    function fakeDeallocator(buffer, context) {
      alert("[deallocator] Deallocator chiamato!");
      
      // Sovrascrive i dati della memoria
      for (let i = 0; i < buffer.length; i++) {
        buffer[i] = 0xFF;
      }

      // *** Simula "liberazione" ***
      externalMemory = null;
    }

    function createTypedArrayWithExternalBuffer(bytes, length, destructor, context) {
      const buffer = bytes.buffer;
      const view = new Uint8Array(buffer, 0, length);
      return {
        view,
        destroy() {
          if (destructor) destructor(view, context);
        }
      };
    }

    alert("Creazione TypedArray da memoria esterna...");
    const handle = createTypedArrayWithExternalBuffer(externalMemory, 4, fakeDeallocator, "ps4Context");

    alert("Contenuto iniziale: " + handle.view.join(", "));

    alert("Distruzione della memoria condivisa...");
    handle.destroy();

    alert("Sostituzione dell'oggetto liberato...");
    let spray = [];
    for (let i = 0; i < 10000; i++) {
      // Spruzza (spray) nuovi ArrayBuffer per cercare di riempire l'area liberata
      spray.push(new ArrayBuffer(0x100));
    }

    alert("Accesso memoria dopo spray...");
    // **Qui tentiamo di leggere valori corrotti**
    let crash = handle.view[0];

    alert("Crash completato: valore letto " + crash);
  </script>
</body>
</html>
