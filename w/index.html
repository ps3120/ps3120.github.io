<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>TypedArray Crash Simulation</title>
</head>
<body>
  <h1> 2 TypedArray Crash Simulation</h1>

  <script>
    let externalMemory = new Uint8Array(0x100);

    function fakeDeallocator(view, context) {
      alert("[deallocator] Eseguo liberazione...");

      // Elimina ogni riferimento
      externalMemory = null;

      // Forza il GC
      for (let i = 0; i < 10000; i++) {
        let tmp = new ArrayBuffer(0x1000);
      }
    }

    function createTypedArrayWithExternalBuffer(bytes, length, destructor, context) {
      const buffer = bytes.buffer;
      const view = new Uint8Array(buffer, 0, length);
      return {
        view,
        destroy() {
          if (destructor) destructor(view, context);
        }
      };
    }

    alert("Creo il TypedArray...");
    const handle = createTypedArrayWithExternalBuffer(externalMemory, 0x100, fakeDeallocator, "ps4test");

    alert("Distruggo...");
    handle.destroy();

    alert("Provo ad accedere...");
    handle.view[0] = 0x41; // <<< Qui può crashare

    alert("Se vedi questo alert, NON è crashato.");
  </script>
</body>
</html>
