<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>PS4 Redis Dump</title>
</head>
<body>

  <script>
    var sceNetSocket  = libKernel.sceNetSocket;
    var sceNetConnect = libKernel.sceNetConnect;
    var sceNetSend    = libKernel.sceNetSend;
    var sceNetRecv    = libKernel.sceNetRecv;
    var sceNetClose   = libKernel.sceNetClose;
    var inet_addr     = libKernel.inet_addr;
    var htons         = libKernel.htons;

    const AF_UNIX = 1;
    const AF_INET = 2;
    const AF_INET6 = 28;
    const SOCK_STREAM = 1;
    const SOCK_DGRAM = 2;
    const SOL_SOCKET = 0xffff;
    const SO_REUSEADDR = 4;
    const SO_LINGER = 0x80;

    const IPPROTO_TCP = 6;
    const IPPROTO_UDP = 17;
    const IPPROTO_IPV6 = 41;

    const TCP_INFO = 0x20;
    const size_tcp_info = 0xec;

    const TCPS_ESTABLISHED = 4;

    const IPV6_2292PKTOPTIONS = 25;
    const IPV6_PKTINFO = 46;
    const IPV6_NEXTHOP = 48;
    const IPV6_RTHDR = 51;
    const IPV6_TCLASS = 61;

    const CPU_LEVEL_WHICH = 3;
    const CPU_WHICH_TID = 1;

    const MAP_SHARED = 1;
    const MAP_FIXED = 0x10;

    const RTP_SET = 1;
    const RTP_PRIO_REALTIME = 2;

    function utf8ToUint8Array(str) {
      return new TextEncoder().encode(str);
    }
    function uint8ArrayToUtf8(arr) {
      return new TextDecoder("utf-8").decode(new Uint8Array(arr));
    }

    function buildRESP(argsArray) {
      var parts = "*" + argsArray.length + "\r\n";
      for (var i = 0; i < argsArray.length; i++) {
        var arg = argsArray[i];
        parts += "$" + arg.length + "\r\n" + arg + "\r\n";
      }
      return parts;
    }

    function sendAndReceive(fd, reqString) {
      var totalSent = 0;
      var buf = utf8ToUint8Array(reqString);
      while (totalSent < buf.length) {
        var sent = sceNetSend(fd, buf.subarray(totalSent), buf.length - totalSent, 0);
        if (sent < 0) return;
        totalSent += sent;
      }
      var responseBytes = [];
      var tmpBuf = new Uint8Array(4096);
      while (true) {
        var r = sceNetRecv(fd, tmpBuf, tmpBuf.length, 0);
        if (r === 0 || r < 0) break;
        for (var i = 0; i < r; i++) responseBytes.push(tmpBuf[i]);
        if (r < tmpBuf.length) break;
      }
      return uint8ArrayToUtf8(responseBytes);
    }

    function execShell(cmd) {
      try { return os.execute(cmd); }
      catch (e) { return ""; }
    }

    function startRedisDump() {
      console.clear();
      execShell("mkdir -p /data/redis/ 2>/dev/null");
      var redis_fd = sceNetSocket("redis_client", AF_INET, SOCK_STREAM, IPPROTO_TCP);
      if (redis_fd < 0) return;
      var sockaddr = new Uint8Array(16);
      sockaddr[0] = AF_INET & 0xff;
      sockaddr[1] = (AF_INET >> 8) & 0xff;
      var port_be = htons(6379);
      sockaddr[2] = port_be & 0xff;
      sockaddr[3] = (port_be >> 8) & 0xff;
      var ip_be = inet_addr("127.0.0.1");
      sockaddr[4] = (ip_be >> 24) & 0xff;
      sockaddr[5] = (ip_be >> 16) & 0xff;
      sockaddr[6] = (ip_be >> 8) & 0xff;
      sockaddr[7] = ip_be & 0xff;
      var ret = sceNetConnect(redis_fd, sockaddr, 16);
      if (ret < 0) return;
      var respDir = sendAndReceive(redis_fd, buildRESP(["CONFIG","GET","dir"]));
      var respDB  = sendAndReceive(redis_fd, buildRESP(["CONFIG","GET","dbfilename"]));
      function parseConfigValue(respText) {
        var lines = respText.split("\r\n");
        for (var i = 0; i < lines.length; i++) {
          if (!lines[i].match(/^\*[0-9]+/) &&
              !lines[i].match(/^\$[0-9]+/) &&
              lines[i] !== "dir" &&
              lines[i] !== "dbfilename") {
            return lines[i];
          }
        }
        return null;
      }
      var currentDir    = parseConfigValue(respDir);
      var currentDbfile = parseConfigValue(respDB);
      var desiredDir    = "/data/redis";
      var desiredDbfile = "dump.rdb";
      if (currentDir !== desiredDir) {
        sendAndReceive(redis_fd, buildRESP(["CONFIG","SET","dir",desiredDir]));
        currentDir = desiredDir;
      }
      if (currentDbfile !== desiredDbfile) {
        sendAndReceive(redis_fd, buildRESP(["CONFIG","SET","dbfilename",desiredDbfile]));
        currentDbfile = desiredDbfile;
      }
      sendAndReceive(redis_fd, buildRESP(["SAVE"]));
      function scanOnce(fd, cursor) {
        var req  = buildRESP(["SCAN", cursor]);
        var resp = sendAndReceive(fd, req);
        var lines = resp.split("\r\n");
        var nextCursor = lines[2];
        var keys = [];
        for (var i = 4; i < lines.length; i += 2) {
          if (lines[i] && !lines[i].match(/^\*(\d+)/) && !lines[i].match(/^\$(\d+)/)) {
            keys.push(lines[i]);
          }
        }
        return { nextCursor: nextCursor, keys: keys };
      }
      function dumpKey(fd, key) {
        var req  = buildRESP(["DUMP", key]);
        var resp = sendAndReceive(fd, req);
        var firstLine = resp.split("\r\n")[0];
        if (!firstLine.startsWith("$")) return;
        var byteLen = parseInt(firstLine.slice(1));
      }
      var cursor = "0";
      do {
        var result = scanOnce(redis_fd, cursor);
        cursor = result.nextCursor;
        for (var i = 0; i < result.keys.length; i++) {
          dumpKey(redis_fd, result.keys[i]);
        }
      } while (cursor !== "0");
      sceNetClose(redis_fd);
    }

    window.onload = startRedisDump;
  </script>
</body>
</html>
